{% extends "admin/layout/admin_base.html" %}

{% block title %}Login Logs - Admin Panel{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="page-header">
        <h2><i class="fas fa-sign-in-alt"></i> Login Logs</h2>
        <div class="page-actions">
            <button class="btn btn-primary">
                <i class="fas fa-download"></i> Export Logs
            </button>
            <button class="btn btn-outline-danger">
                <i class="fas fa-shield-alt"></i> Security Report
            </button>
        </div>
    </div>

    <!-- Login Filters -->
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-group">
                <label>Username:</label>
                <input type="text" class="form-control" placeholder="Search username..." id="usernameFilter">
            </div>
            <div class="filter-group">
                <label>Status:</label>
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="success">Successful</option>
                    <option value="failed">Failed</option>
                    <option value="blocked">Blocked</option>
                </select>
            </div>
            <div class="filter-group">
                <label>IP Address:</label>
                <input type="text" class="form-control" placeholder="IP address..." id="ipFilter">
            </div>
            <div class="filter-group">
                <label>Date Range:</label>
                <input type="date" class="form-control" id="startDate">
                <span>to</span>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="filter-actions">
                <button class="btn btn-outline-primary" onclick="applyFilters()">Apply</button>
                <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>
    </div>

    <!-- Login Logs Table -->
    <div class="table-container">
        <table class="table table-striped table-hover" id="loginLogsTable">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Username</th>
                    <th>Status</th>
                    <th>IP Address</th>
                    <th>Location</th>
                    <th>User Agent</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Login log entries will be loaded dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Login logs pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="loginLogsPagination">
            <!-- Pagination will be generated dynamically -->
        </ul>
    </nav>

    <!-- Login Statistics -->
    <div class="log-stats">
        <h4>Login Analytics (Last 24 hours)</h4>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number" id="totalLogins">1,245</div>
                <div class="stat-label">Total Logins</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="successfulLogins">1,189</div>
                <div class="stat-label">Successful</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="failedLogins">56</div>
                <div class="stat-label">Failed</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="blockedAttempts">12</div>
                <div class="stat-label">Blocked</div>
            </div>
        </div>
    </div>

    <!-- Failed Login Attempts Chart -->
    <div class="chart-container">
        <h4>Failed Login Attempts by IP</h4>
        <canvas id="failedLoginsChart" width="400" height="200"></canvas>
    </div>
</div>

{% include 'admin/layout/components/toast.html' %}
{% include 'admin/layout/components/modal.html' %}
{% include 'admin/layout/components/loader.html' %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadLoginLogs();
    initializeLoginFilters();
    loadLoginStats();
    initializeFailedLoginsChart();
});

function loadLoginLogs(page = 1) {
    const loader = document.getElementById('adminLoader');
    loader.style.display = 'flex';

    fetch(`/api/admin/logs/login?page=${page}`)
        .then(response => response.json())
        .then(data => {
            renderLoginLogsTable(data.logs);
            renderPagination(data.pagination, 'loginLogsPagination', loadLoginLogs);
            loader.style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading login logs:', error);
            showToast('Error', 'Failed to load login logs', 'error');
            loader.style.display = 'none';
        });
}

function renderLoginLogsTable(logs) {
    const tbody = document.querySelector('#loginLogsTable tbody');
    tbody.innerHTML = '';

    logs.forEach(log => {
        const statusClass = log.status === 'success' ? 'success' : log.status === 'failed' ? 'danger' : 'warning';
        const statusIcon = log.status === 'success' ? 'check-circle' : log.status === 'failed' ? 'times-circle' : 'exclamation-triangle';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDateTime(log.timestamp)}</td>
            <td>
                <div class="user-cell">
                    <i class="fas fa-user-circle"></i>
                    <span>${log.username}</span>
                </div>
            </td>
            <td>
                <span class="status-badge ${statusClass}">
                    <i class="fas fa-${statusIcon}"></i> ${log.status}
                </span>
            </td>
            <td>${log.ip_address}</td>
            <td>${log.location || 'Unknown'}</td>
            <td>
                <span class="user-agent" title="${log.user_agent}">${truncateText(log.user_agent, 30)}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewLoginDetails(${log.id})">
                    <i class="fas fa-eye"></i>
                </button>
                ${log.status === 'failed' ? `
                <button class="btn btn-sm btn-outline-danger" onclick="blockIP('${log.ip_address}')">
                    <i class="fas fa-ban"></i>
                </button>
                ` : ''}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function loadLoginStats() {
    fetch('/api/admin/logs/login/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalLogins').textContent = data.stats.total_logins.toLocaleString();
                document.getElementById('successfulLogins').textContent = data.stats.successful_logins.toLocaleString();
                document.getElementById('failedLogins').textContent = data.stats.failed_logins.toLocaleString();
                document.getElementById('blockedAttempts').textContent = data.stats.blocked_attempts.toLocaleString();
            }
        })
        .catch(error => {
            console.error('Error loading login stats:', error);
        });
}

function initializeFailedLoginsChart() {
    fetch('/api/admin/logs/login/failed-by-ip')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ctx = document.getElementById('failedLoginsChart');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.ips.map(ip => ip.ip_address),
                        datasets: [{
                            label: 'Failed Attempts',
                            data: data.ips.map(ip => ip.count),
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading failed logins chart:', error);
        });
}

function initializeLoginFilters() {
    const filters = ['usernameFilter', 'statusFilter', 'ipFilter', 'startDate', 'endDate'];
    let searchTimeout;

    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadLoginLogs();
                }, 500);
            });
            element.addEventListener('change', () => loadLoginLogs());
        }
    });
}

function applyFilters() {
    loadLoginLogs();
}

function clearFilters() {
    document.getElementById('usernameFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('ipFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    loadLoginLogs();
}

function viewLoginDetails(logId) {
    fetch(`/api/admin/logs/login/${logId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showLoginDetailsModal(data.log);
            }
        })
        .catch(error => {
            console.error('Error loading login details:', error);
            showToast('Error', 'Failed to load login details', 'error');
        });
}

function showLoginDetailsModal(log) {
    const modal = document.getElementById('adminModal');
    const modalTitle = document.getElementById('adminModalLabel');
    const modalBody = document.getElementById('adminModalBody');

    modalTitle.textContent = 'Login Details';
    modalBody.innerHTML = `
        <div class="login-details">
            <div class="detail-row">
                <strong>Username:</strong> ${log.username}
            </div>
            <div class="detail-row">
                <strong>Status:</strong>
                <span class="status-badge ${log.status === 'success' ? 'success' : 'danger'}">
                    ${log.status}
                </span>
            </div>
            <div class="detail-row">
                <strong>Timestamp:</strong> ${formatDateTime(log.timestamp)}
            </div>
            <div class="detail-row">
                <strong>IP Address:</strong> ${log.ip_address}
            </div>
            <div class="detail-row">
                <strong>Location:</strong> ${log.location || 'Unknown'}
            </div>
            <div class="detail-row">
                <strong>User Agent:</strong> ${log.user_agent}
            </div>
            ${log.failure_reason ? `
            <div class="detail-row">
                <strong>Failure Reason:</strong> ${log.failure_reason}
            </div>
            ` : ''}
        </div>
    `;

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function blockIP(ipAddress) {
    if (confirm(`Are you sure you want to block IP address ${ipAddress}?`)) {
        fetch('/api/admin/block-ip', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ip_address: ipAddress })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Success', `IP ${ipAddress} has been blocked`, 'success');
                loadLoginLogs();
            } else {
                showToast('Error', data.message || 'Failed to block IP', 'error');
            }
        })
        .catch(error => {
            console.error('Error blocking IP:', error);
            showToast('Error', 'Failed to block IP', 'error');
        });
    }
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function truncateText(text, maxLength) {
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function renderPagination(pagination, paginationId, loadFunction) {
    const paginationEl = document.getElementById(paginationId);
    paginationEl.innerHTML = '';

    for (let i = 1; i <= pagination.total_pages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="${loadFunction.name}(${i})">${i}</a>`;
        paginationEl.appendChild(li);
    }
}

function showToast(title, message, type = 'info') {
    const toast = document.getElementById('adminToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');

    toastTitle.textContent = title;
    toastMessage.textContent = message;

    toast.className = `toast toast-${type}`;

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>
{% endblock %}