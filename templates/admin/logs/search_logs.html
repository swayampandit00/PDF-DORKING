{% extends "admin/layout/admin_base.html" %}

{% block title %}Search Logs - Admin Panel{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="page-header">
        <h2><i class="fas fa-search"></i> Search Logs</h2>
        <div class="page-actions">
            <button class="btn btn-primary">
                <i class="fas fa-download"></i> Export Logs
            </button>
            <button class="btn btn-outline-secondary">
                <i class="fas fa-filter"></i> Advanced Filters
            </button>
        </div>
    </div>

    <!-- Search Filters -->
    <div class="filters-section">
        <div class="filter-row">
            <div class="filter-group">
                <label>Query:</label>
                <input type="text" class="form-control" placeholder="Search query..." id="queryFilter">
            </div>
            <div class="filter-group">
                <label>User:</label>
                <input type="text" class="form-control" placeholder="Username..." id="userFilter">
            </div>
            <div class="filter-group">
                <label>Results:</label>
                <select class="form-select" id="resultsFilter">
                    <option value="">All Results</option>
                    <option value="0">No Results</option>
                    <option value="1-10">1-10 Results</option>
                    <option value="11-50">11-50 Results</option>
                    <option value="50+">50+ Results</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date Range:</label>
                <input type="date" class="form-control" id="startDate">
                <span>to</span>
                <input type="date" class="form-control" id="endDate">
            </div>
            <div class="filter-actions">
                <button class="btn btn-outline-primary" onclick="applyFilters()">Apply</button>
                <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear</button>
            </div>
        </div>
    </div>

    <!-- Search Logs Table -->
    <div class="table-container">
        <table class="table table-striped table-hover" id="searchLogsTable">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Query</th>
                    <th>Results Found</th>
                    <th>Search Time</th>
                    <th>IP Address</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- Search log entries will be loaded dynamically -->
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Search logs pagination" class="mt-4">
        <ul class="pagination justify-content-center" id="searchLogsPagination">
            <!-- Pagination will be generated dynamically -->
        </ul>
    </nav>

    <!-- Search Statistics -->
    <div class="log-stats">
        <h4>Search Analytics (Last 24 hours)</h4>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number" id="totalSearches">8,432</div>
                <div class="stat-label">Total Searches</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgResults">23.5</div>
                <div class="stat-label">Avg Results</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="noResults">1,245</div>
                <div class="stat-label">No Results</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="avgSearchTime">2.3s</div>
                <div class="stat-label">Avg Search Time</div>
            </div>
        </div>
    </div>

    <!-- Popular Queries Chart -->
    <div class="chart-container">
        <h4>Popular Search Queries</h4>
        <canvas id="popularQueriesChart" width="400" height="200"></canvas>
    </div>
</div>

{% include 'admin/layout/components/toast.html' %}
{% include 'admin/layout/components/modal.html' %}
{% include 'admin/layout/components/loader.html' %}
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSearchLogs();
    initializeSearchFilters();
    loadSearchStats();
    initializePopularQueriesChart();
});

function loadSearchLogs(page = 1) {
    const loader = document.getElementById('adminLoader');
    loader.style.display = 'flex';

    fetch(`/api/admin/logs/search?page=${page}`)
        .then(response => response.json())
        .then(data => {
            renderSearchLogsTable(data.logs);
            renderPagination(data.pagination, 'searchLogsPagination', loadSearchLogs);
            loader.style.display = 'none';
        })
        .catch(error => {
            console.error('Error loading search logs:', error);
            showToast('Error', 'Failed to load search logs', 'error');
            loader.style.display = 'none';
        });
}

function renderSearchLogsTable(logs) {
    const tbody = document.querySelector('#searchLogsTable tbody');
    tbody.innerHTML = '';

    logs.forEach(log => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${formatDateTime(log.timestamp)}</td>
            <td>
                <div class="user-cell">
                    <i class="fas fa-user-circle"></i>
                    <span>${log.username}</span>
                </div>
            </td>
            <td>
                <span class="query-text" title="${log.query}">${truncateText(log.query, 50)}</span>
            </td>
            <td>${log.results_count}</td>
            <td>${log.search_time}s</td>
            <td>${log.ip_address}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewSearchDetails(${log.id})">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function loadSearchStats() {
    fetch('/api/admin/logs/search/stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('totalSearches').textContent = data.stats.total_searches.toLocaleString();
                document.getElementById('avgResults').textContent = data.stats.avg_results;
                document.getElementById('noResults').textContent = data.stats.no_results.toLocaleString();
                document.getElementById('avgSearchTime').textContent = data.stats.avg_search_time + 's';
            }
        })
        .catch(error => {
            console.error('Error loading search stats:', error);
        });
}

function initializePopularQueriesChart() {
    fetch('/api/admin/logs/search/popular')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const ctx = document.getElementById('popularQueriesChart');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.queries.map(q => truncateText(q.query, 20)),
                        datasets: [{
                            label: 'Search Count',
                            data: data.queries.map(q => q.count),
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error loading popular queries:', error);
        });
}

function initializeSearchFilters() {
    const filters = ['queryFilter', 'userFilter', 'resultsFilter', 'startDate', 'endDate'];
    let searchTimeout;

    filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
            element.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadSearchLogs();
                }, 500);
            });
            element.addEventListener('change', () => loadSearchLogs());
        }
    });
}

function applyFilters() {
    loadSearchLogs();
}

function clearFilters() {
    document.getElementById('queryFilter').value = '';
    document.getElementById('userFilter').value = '';
    document.getElementById('resultsFilter').value = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    loadSearchLogs();
}

function viewSearchDetails(logId) {
    fetch(`/api/admin/logs/search/${logId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSearchDetailsModal(data.log);
            }
        })
        .catch(error => {
            console.error('Error loading search details:', error);
            showToast('Error', 'Failed to load search details', 'error');
        });
}

function showSearchDetailsModal(log) {
    const modal = document.getElementById('adminModal');
    const modalTitle = document.getElementById('adminModalLabel');
    const modalBody = document.getElementById('adminModalBody');

    modalTitle.textContent = 'Search Details';
    modalBody.innerHTML = `
        <div class="search-details">
            <div class="detail-row">
                <strong>Query:</strong> ${log.query}
            </div>
            <div class="detail-row">
                <strong>User:</strong> ${log.username}
            </div>
            <div class="detail-row">
                <strong>Timestamp:</strong> ${formatDateTime(log.timestamp)}
            </div>
            <div class="detail-row">
                <strong>Results Found:</strong> ${log.results_count}
            </div>
            <div class="detail-row">
                <strong>Search Time:</strong> ${log.search_time}s
            </div>
            <div class="detail-row">
                <strong>IP Address:</strong> ${log.ip_address}
            </div>
            <div class="detail-row">
                <strong>User Agent:</strong> ${log.user_agent}
            </div>
            ${log.results ? `
            <div class="detail-row">
                <strong>Top Results:</strong>
                <ul class="results-list">
                    ${log.results.slice(0, 5).map(result => `<li><a href="${result.url}" target="_blank">${result.title}</a></li>`).join('')}
                </ul>
            </div>
            ` : ''}
        </div>
    `;

    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function formatDateTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function truncateText(text, maxLength) {
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

function renderPagination(pagination, paginationId, loadFunction) {
    const paginationEl = document.getElementById(paginationId);
    paginationEl.innerHTML = '';

    for (let i = 1; i <= pagination.total_pages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="${loadFunction.name}(${i})">${i}</a>`;
        paginationEl.appendChild(li);
    }
}

function showToast(title, message, type = 'info') {
    const toast = document.getElementById('adminToast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');

    toastTitle.textContent = title;
    toastMessage.textContent = message;

    toast.className = `toast toast-${type}`;

    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}
</script>
{% endblock %}